#!/usr/bin/with-contenv bashio
# vim: ft=bash
# shellcheck shell=bash
# ==============================================================================
# Start universal-silabs-flasher
# ==============================================================================

set -e

# shellcheck disable=SC2034
declare autoflash_firmware
declare device
declare port
declare bootloader_baudrate
declare ezsp_baudrate
declare firmware
declare verbose

declare exit_status

function cleanup() {
    exit_status=$?
    bashio::log.info "universal-silabs-flasher-up script exited with code ${exit_status}"
    echo "${exit_status}" > /run/s6-linux-init-container-results/exitcode

    /run/s6/basedir/bin/halt
}
trap cleanup EXIT

function exit_no_firmware {
    bashio::log.warning "No firmware found for the selected device, assuming firmware is installed."
    exit 0
}

device=$(bashio::config 'device')
bootloader_baudrate=$(bashio::config 'bootloader_baudrate')
ezsp_baudrate=$(bashio::config 'ezsp_baudrate')
verbose=""
if bashio::config.true 'verbose'; then
    verbose="-v"
fi

allow_cross_flashing=""
if bashio::config.true 'allow_cross_flashing'; then
    allow_cross_flashing="--allow-cross-flashing"
fi

allow_downgrades=""
if bashio::config.true 'allow_downgrades'; then
    allow_downgrades="--allow-downgrades"
fi


if bashio::config.has_value 'firmware_url'; then
    curl --silent -L -o "/root/firmware.gbl" "$(bashio::config 'firmware_url')"
    if [ ! -f "/root/firmware.gbl" ]; then
        bashio::log.warning "Downloading firmware failed"
        exit 0
    fi
    firmware="firmware.gbl"
    universal-silabs-flasher \
    ${verbose} \
    --device ${device} \
    --bootloader-baudrate "${bootloader_baudrate}" \
    --ezsp-baudrate "${ezsp_baudrate}" \
    flash --firmware "/root/${firmware}" \
    ${allow_cross_flashing} \
    ${allow_downgrades} 
else
    bashio::log.info "开始读取信息"
    universal-silabs-flasher \
    ${verbose} \
    --device ${device} \
    --bootloader-baudrate "${bootloader_baudrate}" \
    --ezsp-baudrate "${ezsp_baudrate}" \
    probe --probe-method "bootloader ezsp"
    bashio::log.warning "结束读取信息"
fi
